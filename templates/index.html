{% extends "base.html" %}

{% block title %}株価チャート{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h2>{{ chart_data_py.ticker }} 株価チャート</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="chart-container mt-3">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">銘柄検索</h5>
                <form id="searchForm">
                    <div class="input-group">
                        <input type="text" id="tickerInput" class="form-control" placeholder="例: GOOGL, MSFT" required>
                        <button class="btn btn-primary" type="submit">検索</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">取引: {{ chart_data_py.ticker }}</h5>
                <p class="card-text">現在価格: ${{ chart_data_py.current_price }}</p>
                <p class="card-text">翌日予測: <span class="badge bg-info">${{ predicted_price }}</span></p>
                <form action="{{ url_for('buy', ticker=chart_data_py.ticker) }}" method="post" class="mb-2">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="数量">
                        <button type="submit" class="btn btn-success">買う</button>
                    </div>
                </form>
                <form action="{{ url_for('sell', ticker=chart_data_py.ticker) }}" method="post">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="数量">
                        <button type="submit" class="btn btn-danger">売る</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">ポートフォリオ</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>仮想残高</span> <strong>${{ portfolio.balance }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>株式評価額</span> <strong>${{ portfolio.holdings_value }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><h5>総資産</h5> <h5>${{ portfolio.total_asset }}</h5></li>
                </ul>
                <h6 class="mt-3">保有株一覧</h6>
                <ul class="list-group">
                    {% for stock in holdings %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ stock.ticker }} ({{ stock.shares }}株)</span>
                        <span>${{ stock.value }}</span>
                    </li>
                    {% else %}
                    <li class="list-group-item">保有株はありません。</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 検索フォームの処理
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const ticker = document.getElementById('tickerInput').value.toUpperCase();
        window.location.href = '/stock/' + ticker;
    });

    // チャート描画
    const chartData = JSON.parse('{{ chart_data_json | safe }}');
    const ctx = document.getElementById('stockChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line', data: { labels: chartData.labels,
        datasets: [ { label: `${chartData.ticker} の終値（実績）`, data: chartData.data, borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 2, fill: false, tension: 0.1 },
                    { label: '予測', data: chartData.prediction_data, borderColor: 'rgba(255, 99, 132, 1)', borderWidth: 2, borderDash: [5, 5], fill: false, tension: 0.1 } ] },
        options: { scales: { y: { beginAtZero: false } } }
    });
</script>
{% endblock %}