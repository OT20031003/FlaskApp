{% extends "base.html" %}

{% block title %}{{ company_name | default(chart_data_py.ticker) }} æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        
        <h1 class="mb-3">{{ company_name | default(chart_data_py.ticker) }} ({{ chart_data_py.ticker }}) æ ªä¾¡ãƒãƒ£ãƒ¼ãƒˆ</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if gemini_description %}
        <div class="card mb-4 bg-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-secondary">ğŸ¤– éŠ˜æŸ„æ¦‚è¦ (by Gemini)</h5>
                <p class="card-text" style="white-space: pre-wrap;">{{ gemini_description }}</p>
            </div>
        </div>
        {% endif %}

        <div class="chart-container mt-3">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <div class="col-md-4">
        
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">éŠ˜æŸ„æ¤œç´¢</h5>
                <form id="searchForm">
                    <div class="input-group">
                        <input type="text" id="tickerInput" class="form-control" placeholder="ä¾‹: GOOGL, MSFT" required>
                        <button class="btn btn-primary" type="submit">æ¤œç´¢</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">å–å¼•: {{ chart_data_py.ticker }}</h5>
                <p class="card-text">ç¾åœ¨ä¾¡æ ¼: ${{ chart_data_py.current_price }}</p>
                
                <p class="card-text">ç¿Œæ—¥äºˆæ¸¬ (LSTM): <span class="badge bg-info">${{ predicted_price_lstm }}</span></p>
                
                <p class="card-text">ç¿Œæ—¥äºˆæ¸¬ (Ridge): <span class="badge bg-warning text-dark">${{ predicted_price_ridge }}</span></p>

                <form method="GET" action="{{ url_for('index', ticker=chart_data_py.ticker) }}" class="row g-2 align-items-center mb-3">
                    <div class="col-auto">
                         <label for="predict_len">äºˆæ¸¬ã™ã‚‹æ—¥ä»˜:</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="predict_len" name="predict_len" class="form-control" value="{{ request.args.get('predict_len', 10) }}" min="1">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm">äºˆæ¸¬</button>
                    </div>
                </form>
                
                <form action="{{ url_for('buy', ticker=chart_data_py.ticker) }}" method="post" class="mb-2">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="æ•°é‡">
                        <button type="submit" class="btn btn-success">è²·ã†</button>
                    </div>
                </form>
                <form action="{{ url_for('sell', ticker=chart_data_py.ticker) }}" method="post">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="æ•°é‡">
                        <button type="submit" class="btn btn-danger">å£²ã‚‹</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>ä»®æƒ³æ®‹é«˜</span> <strong>${{ portfolio.balance }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>æ ªå¼è©•ä¾¡é¡</span> <strong>${{ portfolio.holdings_value }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><h5>ç·è³‡ç”£</h5> <h5>${{ portfolio.total_asset }}</h5></li>
                </ul>
                <h6 class="mt-3">ä¿æœ‰æ ªä¸€è¦§</h6>
                <ul class="list-group">
                    {% for stock in holdings %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ stock.ticker }} ({{ stock.shares }}æ ª)</span>
                        <span>${{ stock.value }}</span>
                    </li>
                    {% else %}
                    <li class="list-group-item">ä¿æœ‰æ ªã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const ticker = document.getElementById('tickerInput').value.toUpperCase();
        window.location.href = '/stock/' + ticker;
    });

    const chartData = JSON.parse('{{ chart_data_json | safe }}');
    const ctx = document.getElementById('stockChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line', 
        data: { 
            labels: chartData.labels,
            datasets: [ 
                { 
                    label: `${chartData.ticker} ã®çµ‚å€¤ï¼ˆå®Ÿç¸¾ï¼‰`, 
                    data: chartData.data, 
                    borderColor: 'rgba(75, 192, 192, 1)', // é’ç·‘
                    borderWidth: 2, 
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                },
                { 
                    label: 'äºˆæ¸¬ (LSTM)',
                    data: chartData.prediction_data_lstm, 
                    borderColor: 'rgba(255, 99, 132, 1)', // èµ¤
                    borderWidth: 2, 
                    borderDash: [5, 5], // ç ´ç·š
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                },
                { 
                    label: 'äºˆæ¸¬ (Ridge)',
                    data: chartData.prediction_data_ridge,
                    borderColor: 'rgba(255, 159, 64, 1)', // ã‚ªãƒ¬ãƒ³ã‚¸
                    borderWidth: 2, 
                    borderDash: [10, 5], // åˆ¥ã®ç ´ç·š
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                }
            ] 
        },
        options: { 
            scales: { 
                y: { beginAtZero: false } 
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
</script>
{% endblock %}