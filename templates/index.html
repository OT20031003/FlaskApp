{% extends "base.html" %}

{% block title %}{{ company_name | default(chart_data_py.ticker) }} 株価チャート{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        
        <h1 class="mb-3">{{ company_name | default(chart_data_py.ticker) }} ({{ chart_data_py.ticker }}) 株価チャート</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if gemini_description %}
        <div class="card mb-4 bg-light border-secondary">
            <div class="card-body">
                <h5 class="card-title text-secondary"> 銘柄概要 (by Gemini)</h5>
                <p class="card-text" style="white-space: pre-wrap;">{{ gemini_description }}</p>
            </div>
        </div>
        {% endif %}

        <div class="chart-container mt-3">
            <canvas id="stockChart"></canvas>
        </div>
    </div>

    <div class="col-md-4">
        
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">銘柄検索</h5>
                <form id="searchForm">
                    <div class="input-group">
                        <input type="text" id="tickerInput" class="form-control" placeholder="例: GOOGL, MSFT" required>
                        <button class="btn btn-primary" type="submit">検索</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">取引: {{ chart_data_py.ticker }}</h5>
                <p class="card-text">現在価格: ${{ chart_data_py.current_price }}</p>
                
                <p class="card-text">翌日予測 (LSTM): <span class="badge" style="background-color: rgba(255, 99, 132, 1);">${{ predicted_price_lstm }}</span></p>
                
                <p class="card-text">翌日予測 (Ridge): <span class="badge text-dark" style="background-color: rgba(255, 159, 64, 1);">${{ predicted_price_ridge }}</span></p>
                
                <form method="GET" action="{{ url_for('index', ticker=chart_data_py.ticker) }}" class="row g-2 align-items-center mb-3">
                    <div class="col-auto">
                         <label for="predict_len">予測する日付:</label>
                    </div>
                    <div class="col-auto">
                        <input type="number" id="predict_len" name="predict_len" class="form-control" value="{{ request.args.get('predict_len', 10) }}" min="1">
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary btn-sm">予測</button>
                    </div>
                </form>
                
                <form action="{{ url_for('buy', ticker=chart_data_py.ticker) }}" method="post" class="mb-2">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="数量">
                        <button type="submit" class="btn btn-success">買う</button>
                    </div>
                </form>
                <form action="{{ url_for('sell', ticker=chart_data_py.ticker) }}" method="post">
                    <div class="input-group">
                        <input type="number" name="shares" class="form-control" min="1" required placeholder="数量">
                        <button type="submit" class="btn btn-danger">売る</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">ポートフォリオ</h5>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between"><span>仮想残高</span> <strong>${{ portfolio.balance }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><span>株式評価額</span> <strong>${{ portfolio.holdings_value }}</strong></li>
                    <li class="list-group-item d-flex justify-content-between"><h5>総資産</h5> <h5>${{ portfolio.total_asset }}</h5></li>
                </ul>
                <h6 class="mt-3">保有株一覧</h6>
                <ul class="list-group">
                    {% for stock in holdings %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ stock.ticker }} ({{ stock.shares }}株)</span>
                        <span>${{ stock.value }}</span>
                    </li>
                    {% else %}
                    <li class="list-group-item">保有株はありません。</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>

    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const ticker = document.getElementById('tickerInput').value.toUpperCase();
        window.location.href = '/stock/' + ticker;
    });

    const chartData = JSON.parse('{{ chart_data_json | safe }}');
    const ctx = document.getElementById('stockChart').getContext('2d');
    const myChart = new Chart(ctx, {
        type: 'line', 
        data: { 
            labels: chartData.labels,
            datasets: [ 
                { 
                    label: `${chartData.ticker} の終値（実績）`, 
                    data: chartData.data, 
                    borderColor: 'rgba(75, 192, 192, 1)', // 青緑
                    borderWidth: 2, 
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                },
                { 
                    label: '予測 (LSTM)',
                    data: chartData.prediction_data_lstm, 
                    borderColor: 'rgba(255, 99, 132, 1)', // 赤
                    borderWidth: 2, 
                    borderDash: [5, 5], // 破線
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                },
                { 
                    label: '予測 (Ridge)',
                    data: chartData.prediction_data_ridge,
                    borderColor: 'rgba(255, 159, 64, 1)', // オレンジ
                    borderWidth: 2, 
                    borderDash: [10, 5], // 別の破線
                    fill: false, 
                    tension: 0.1, 
                    pointRadius: 1, 
                    pointHitRadius: 10 
                }
            ] 
        },
        options: { 
            scales: { 
                y: { beginAtZero: false } 
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });
</script>
{% endblock %}